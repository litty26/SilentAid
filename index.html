<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SilentAid ‚Äî Login</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="auth-container">
    <section class="auth-card">
      <div class="brand">
        <div class="brand-logo">ü§ñ</div>
        <h1>SilentAid</h1>
        <p class="tagline">Your AI Companion for Non-Verbal Communication</p>
      </div>

      <div class="role-select">
        <button id="userRoleBtn" class="role-btn active">üë§ User</button>
        <button id="caregiverRoleBtn" class="role-btn">üßë‚Äç‚öïÔ∏è Caregiver</button>
      </div>

      <!-- Sign In -->
      <div id="signinForm" class="form">
        <input id="signinUsername" class="input" placeholder="Username" />
        <input id="signinPassword" class="input" placeholder="Password" type="password" />
        <div class="row">
          <button id="signinBtn" class="btn btn-primary">Sign In</button>
          <button id="gotoSignup" class="btn btn-ghost" type="button">Create Account</button>
        </div>
        <label class="checkbox">
          <input id="rememberCheckbox" type="checkbox" />
          Remember me
        </label>
      </div>

      <!-- Sign Up -->
      <div id="signupForm" class="form" style="display:none;">
        <input id="signupUsername" class="input" placeholder="Choose username" />
        <input id="signupPassword" class="input" placeholder="Choose password" type="password" />
        <input id="signupPassword2" class="input" placeholder="Confirm password" type="password" />
        <input id="signupEmail" class="input" placeholder="Email (optional)" />
        <select id="signupRoleSelector" class="input" style="display:none;">
          <option value="user">User</option>
          <option value="caregiver">Caregiver</option>
        </select>
        <input id="connectUser" class="input" placeholder="(Caregiver) Connect to user (username)" style="display:none;" />
        <div class="row">
          <button id="signupBtn" class="btn btn-primary">Sign Up</button>
          <button id="gotoSignin" class="btn btn-ghost" type="button">Back to Sign in</button>
        </div>
        <p class="help">Passwords are stored locally (encoded). For production, use a proper backend and hashing.</p>
      </div>

      <div class="hr"></div>
      <div style="margin-top:14px; text-align:center;">
        <button id="demoUser" class="btn btn-ghost" type="button">Try demo user</button>
      </div>
    </section>
  </main>

  <script>
    /*
      Simple local auth manager.
      Data model (localStorage):
       - "users" : { username: { password: "<btoa>", role: "user"|"caregiver", email, connectedUser } }
       - "currentSession" : { username, role }
    */
    const qs = id => document.getElementById(id);

    function loadUsers() {
      try { return JSON.parse(localStorage.getItem('users') || '{}'); }
      catch { return {}; }
    }
    function saveUsers(u) {
      localStorage.setItem('users', JSON.stringify(u));
    }
    
    // Role selection
    let selectedRole = 'user';
    const userRoleBtn = qs('userRoleBtn');
    const caregiverRoleBtn = qs('caregiverRoleBtn');

    function setRole(role) {
      selectedRole = role;
      userRoleBtn.classList.toggle('active', role === 'user');
      caregiverRoleBtn.classList.toggle('active', role === 'caregiver');
      // reflect selection on hidden selector and caregiver connect field
      qs('signupRoleSelector').value = role;
      qs('signupRoleSelector').style.display = 'none';
      qs('connectUser').style.display = role === 'caregiver' ? 'block' : 'none';
    }

    userRoleBtn.addEventListener('click', () => setRole('user'));
    caregiverRoleBtn.addEventListener('click', () => setRole('caregiver'));

    // toggle forms
    qs('gotoSignup').addEventListener('click', () => {
      qs('signinForm').style.display = 'none';
      qs('signupForm').style.display = 'block';
    });
    qs('gotoSignin').addEventListener('click', () => {
      qs('signinForm').style.display = 'block';
      qs('signupForm').style.display = 'none';
    });

    // signup
    qs('signupBtn').addEventListener('click', () => {
      const uname = qs('signupUsername').value.trim();
      const pw = qs('signupPassword').value;
      const pw2 = qs('signupPassword2').value;
      const email = qs('signupEmail').value.trim();
      const connectUser = qs('connectUser').value.trim();

      if (!uname || !pw) return alert('Enter username & password');
      if (pw !== pw2) return alert('Passwords do not match');

      const users = loadUsers();
      if (users[uname]) return alert('Username already exists');

      users[uname] = {
        password: btoa(pw),
        role: selectedRole,
        email: email || '',
        connectedUser: selectedRole === 'caregiver' && connectUser ? connectUser : ''
      };
      saveUsers(users);

      alert('Account created! You can sign in now.');
      // prefill signin
      qs('signinUsername').value = uname;
      qs('signinPassword').value = pw;
      qs('signinForm').style.display = 'block';
      qs('signupForm').style.display = 'none';
    });

    // signin
    qs('signinBtn').addEventListener('click', () => {
      const uname = qs('signinUsername').value.trim();
      const pw = qs('signinPassword').value;
      const remember = qs('rememberCheckbox').checked;

      if (!uname || !pw) return alert('Enter credentials');

      const users = loadUsers();
      if (!users[uname] || users[uname].password !== btoa(pw)) {
        return alert('Invalid username or password');
      }

      const role = users[uname].role || 'user';
      const session = { username: uname, role };
      localStorage.setItem('currentSession', JSON.stringify(session));
      if (remember) localStorage.setItem('rememberedSession', JSON.stringify(session));

      // redirect based on role
      location.href = role === 'user' ? 'user.html' : 'caregiver.html';
    });

    // demo user quick create
    qs('demoUser').addEventListener('click', () => {
      const users = loadUsers();
      if (!users['demo_user']) {
        users['demo_user'] = { password: btoa('demo123'), role: 'user', email: 'demo@example.com', connectedUser: '' };
        users['demo_cg'] = { password: btoa('demo123'), role: 'caregiver', email: 'cg@example.com', connectedUser: 'demo_user' };
        saveUsers(users);
      }
      qs('signinUsername').value = 'demo_user';
      qs('signinPassword').value = 'demo123';
      alert('Demo user & caregiver created. Sign in as "demo_user"/"demo123" or "demo_cg"/"demo123"');
    });

    // auto-login if remembered
    window.addEventListener('load', () => {
      const rem = localStorage.getItem('rememberedSession');
      if (rem) {
        try{
          const s = JSON.parse(rem);
          localStorage.setItem('currentSession', JSON.stringify(s));
          location.href = s.role === 'user' ? 'user.html' : 'caregiver.html';
        }catch{/* ignore malformed */}
      }
    });
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js")
      .then(() => console.log("‚úÖ Service Worker registered"))
      .catch(err => console.error("‚ö†Ô∏è Service Worker failed", err));
  }
</script>
</body>
</html>
